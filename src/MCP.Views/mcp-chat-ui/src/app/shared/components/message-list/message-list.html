<div class="message-list-container">
  <!-- Sticky Header Section with Filters and Search -->
  @if (messages().length > 0) {
  <div class="sticky-header">
    <!-- Filter Controls -->
    <mat-expansion-panel class="filter-panel">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>filter_list</mat-icon>
          <span>Message Filters</span>
        </mat-panel-title>
      </mat-expansion-panel-header>

      <div class="filter-section">
        <h4>Message Roles</h4>
        <div class="filter-group">
          <mat-checkbox
            [checked]="messageFilters().roles.user"
            (change)="toggleRole('user')"
          >
            User
          </mat-checkbox>
          <mat-checkbox
            [checked]="messageFilters().roles.assistant"
            (change)="toggleRole('assistant')"
          >
            Assistant
          </mat-checkbox>
          <mat-checkbox
            [checked]="messageFilters().roles.tool"
            (change)="toggleRole('tool')"
          >
            Tool
          </mat-checkbox>
          <mat-checkbox
            [checked]="messageFilters().roles.system"
            (change)="toggleRole('system')"
          >
            System
          </mat-checkbox>
        </div>
      </div>

      <div class="filter-section">
        <h4>Content Types</h4>
        <div class="filter-group">
          <mat-checkbox
            [checked]="messageFilters().contentTypes.text"
            (change)="toggleContentType('text')"
          >
            Text
          </mat-checkbox>
          <mat-checkbox
            [checked]="messageFilters().contentTypes.reasoning"
            (change)="toggleContentType('reasoning')"
          >
            Reasoning
          </mat-checkbox>
          <mat-checkbox
            [checked]="messageFilters().contentTypes.error"
            (change)="toggleContentType('error')"
          >
            Error
          </mat-checkbox>
          <mat-checkbox
            [checked]="messageFilters().contentTypes.functionCall"
            (change)="toggleContentType('functionCall')"
          >
            Function Call
          </mat-checkbox>
          <mat-checkbox
            [checked]="messageFilters().contentTypes.functionResult"
            (change)="toggleContentType('functionResult')"
          >
            Function Result
          </mat-checkbox>
        </div>
      </div>

      <div class="filter-actions">
        <button mat-button (click)="resetFilters()" class="reset-button">
          <mat-icon>refresh</mat-icon>
          Reset Filters
        </button>
      </div>
    </mat-expansion-panel>

    <!-- Search Section -->
    <div class="search-section">
      <div class="search-input-container">
        <mat-icon class="search-icon">search</mat-icon>
        <input
          type="text"
          class="search-input"
          placeholder="Search messages..."
          [value]="searchQuery()"
          (input)="updateSearchQuery($any($event.target).value)"
        />
        @if (searchQuery()) {
        <button
          mat-icon-button
          class="clear-search-button"
          (click)="clearSearch()"
          title="Clear search"
          aria-label="Clear search"
        >
          <mat-icon>close</mat-icon>
        </button>
        }
      </div>
      @if (searchResultInfo(); as resultInfo) {
      <div class="search-results-info">
        <span class="results-text">
          Found {{ resultInfo.filtered }} of {{ resultInfo.total }}
          {{ resultInfo.total === 1 ? "message" : "messages" }}
        </span>
      </div>
      }
    </div>
  </div>
  } @if (filteredMessages().length === 0 && messages().length > 0) {
  <div class="empty-state">
    @if (searchQuery()) {
    <mat-icon class="empty-icon">search_off</mat-icon>
    <h3>No messages found</h3>
    <p>No messages match your search criteria. Try a different search term.</p>
    } @else {
    <mat-icon class="empty-icon">chat_bubble_outline</mat-icon>
    <h3>Start a conversation</h3>
    <p>Type a message below to begin chatting with the AI assistant.</p>
    }
  </div>
  } @else if (messages().length === 0) {
  <div class="empty-state">
    <mat-icon class="empty-icon">chat_bubble_outline</mat-icon>
    <h3>Start a conversation</h3>
    <p>Type a message below to begin chatting with the AI assistant.</p>
  </div>
  } @else {
  <div class="messages">
    @for (message of filteredMessages(); track $index) {
    <div
      class="message-wrapper"
      [class.user-message]="message.role === 'user'"
      [class.non-user-message]="message.role !== 'user'"
    >
      <mat-card
        class="message-card"
        [class.error-message]="isErrorMessage(message)"
      >
        <mat-card-content>
          <app-message-header [message]="message" />

          <app-message-content-renderer
            [message]="message"
            [searchQuery]="searchQuery()"
            [contentTypeFilter]="messageFilters().contentTypes"
            [showSpinner]="
              isLoading() && $index === filteredMessages().length - 1
            "
          />

          <app-message-footer [message]="message" />
        </mat-card-content>
      </mat-card>
    </div>
    } @if (isAwaitingResponse() ) {
    <div class="waiting-server-indicator">
      <mat-spinner diameter="32" color="primary"></mat-spinner>
      <div class="waiting-text">
        <mat-icon color="primary" class="waiting-icon">cloud_sync</mat-icon>
        <span
          ><strong>Connecting to AI server...</strong><br />Please wait while we
          process your request.</span
        >
      </div>
    </div>
    }
  </div>
  }
</div>
